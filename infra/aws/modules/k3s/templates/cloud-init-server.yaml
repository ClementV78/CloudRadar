#cloud-config
package_update: true
%{ if serial_console_password_hash != "" }
users:
  - name: ec2-user
    lock_passwd: false
    passwd: ${serial_console_password_hash}
    groups: [wheel]
    sudo: ["ALL=(ALL) ALL"]
%{ endif }
runcmd:
  - (command -v dnf >/dev/null 2>&1 && dnf install -y amazon-ssm-agent) || (command -v yum >/dev/null 2>&1 && yum install -y amazon-ssm-agent)
  - systemctl enable --now amazon-ssm-agent
  - |
      if ! swapon --show | grep -q '/swapfile'; then
        if [ ! -f /swapfile ]; then
          fallocate -l 2G /swapfile
          chmod 600 /swapfile
          mkswap /swapfile
        fi
        swapon /swapfile
      fi
      grep -q '^/swapfile ' /etc/fstab || echo '/swapfile none swap sw 0 0' >> /etc/fstab
  - |
      mkdir -p /var/lib/rancher/k3s/server/manifests
      cat <<'EOF' >/var/lib/rancher/k3s/server/manifests/traefik-config.yaml
      apiVersion: helm.cattle.io/v1
      kind: HelmChartConfig
      metadata:
        name: traefik
        namespace: kube-system
      spec:
        valuesContent: |
          ports:
            web:
              nodePort: 30080
            websecure:
              nodePort: 30443
          metrics:
            prometheus:
              enabled: true
              addEntryPointsLabels: true
              addServicesLabels: true
      EOF
  - curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --secrets-encryption${server_args}" K3S_TOKEN="${k3s_token}" sh -
