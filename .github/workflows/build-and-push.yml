name: Build and Push Multi-Service Images

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'VERSION'
      - '.github/workflows/build-and-push.yml'
      - 'Dockerfile*'
      - '.dockerignore'
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
    paths:
      - 'src/**'
      - 'VERSION'
      - '.github/workflows/build-and-push.yml'
      - 'Dockerfile*'
      - '.dockerignore'

env:
  REGISTRY: ghcr.io
  REGISTRY_USERNAME: ${{ github.repository_owner }}
  REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

jobs:
  java-tests:
    name: Java tests (${{ matrix.service }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - ingester
          - processor
          - dashboard

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven
          cache-dependency-path: src/${{ matrix.service }}/pom.xml

      - name: Run Java tests
        working-directory: ./src/${{ matrix.service }}
        run: mvn -B test

  frontend-tests:
    name: Frontend tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: src/frontend/package-lock.json

      - name: Run frontend tests
        working-directory: ./src/frontend
        run: |
          npm ci
          npm test -- --run

  dockerfile-lint:
    name: Hadolint ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - ingester
          - processor
          - frontend
          - dashboard
          - health
          - admin-scale

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint service Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: src/${{ matrix.service }}/Dockerfile
          failure-threshold: error

  dependency-security-scan:
    name: Trivy fs dependency scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan dependencies in src/
        uses: aquasecurity/trivy-action@master
        with:
          scanners: vuln
          scan-type: fs
          scan-ref: src
          vuln-type: library
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "1"
          format: table

  build-and-push:
    name: Build & Push ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs:
      - java-tests
      - frontend-tests
      - dockerfile-lint
      - dependency-security-scan
    strategy:
      fail-fast: false
      matrix:
        service:
          - ingester
          - processor
          - frontend
          - dashboard
          - health
          - admin-scale

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load VERSION
        run: |
          set -euo pipefail
          APP_VERSION="$(tr -d ' \t\r\n' < VERSION)"
          echo "APP_VERSION=${APP_VERSION}" >> "$GITHUB_ENV"

      - name: Set lowercase repository name
        run: echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> "$GITHUB_ENV"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.REPO_LOWER }}/${{ matrix.service }}
          tags: |
            type=ref,event=pr
            type=ref,event=branch
            type=sha
            type=semver,pattern={{version}}
            type=raw,value=${{ env.APP_VERSION }},enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./src/${{ matrix.service }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Log image details
        if: github.event_name != 'pull_request'
        run: |
          echo "✅ Image built and pushed for ${{ matrix.service }}"
          echo "Registry: ${{ env.REGISTRY }}"
          echo "Repository: ${{ env.REPO_LOWER }}"
          echo "Tags:"
          echo "${{ steps.meta.outputs.tags }}" | tr ',' '\n' | sed 's/^/  - /'

  ci-summary-report:
    name: CI summary report
    runs-on: ubuntu-latest
    if: always()
    needs:
      - java-tests
      - frontend-tests
      - dockerfile-lint
      - dependency-security-scan
      - build-and-push
    steps:
      - name: Publish run summary
        run: |
          {
            echo "## CI Quality Summary"
            echo ""
            echo "- Workflow: \`${GITHUB_WORKFLOW}\`"
            echo "- Event: \`${GITHUB_EVENT_NAME}\`"
            echo "- Ref: \`${GITHUB_REF}\`"
            echo ""
            echo "| Gate | Result |"
            echo "| --- | --- |"
            echo "| Java tests | ${{ needs['java-tests'].result }} |"
            echo "| Frontend tests | ${{ needs['frontend-tests'].result }} |"
            echo "| Hadolint (Dockerfiles) | ${{ needs['dockerfile-lint'].result }} |"
            echo "| Trivy fs dependency scan | ${{ needs['dependency-security-scan'].result }} |"
            echo "| Build-and-push matrix | ${{ needs['build-and-push'].result }} |"
            echo ""

            if [ "${{ needs['java-tests'].result }}" != "success" ] || \
               [ "${{ needs['frontend-tests'].result }}" != "success" ] || \
               [ "${{ needs['dockerfile-lint'].result }}" != "success" ] || \
               [ "${{ needs['dependency-security-scan'].result }}" != "success" ]; then
              echo "❌ One or more quality gates failed. Check the job logs and annotations."
            else
              echo "✅ All quality gates passed."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
