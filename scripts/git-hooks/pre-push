#!/usr/bin/env bash
set -euo pipefail

# Local pre-push guard:
# Block push when commits being pushed modify src/** without updating VERSION.
# Bypass locally with: SKIP_VERSION_GUARD=1 git push

remote_name="${1:-origin}"

if [[ "${SKIP_VERSION_GUARD:-0}" == "1" ]]; then
  exit 0
fi

is_zero_sha() {
  [[ "$1" =~ ^0+$ ]]
}

src_changed=0
version_changed=0

while read -r local_ref local_sha remote_ref remote_sha; do
  # No update line (defensive)
  if [[ -z "${local_ref:-}" ]]; then
    continue
  fi

  # Branch/tag deletion
  if is_zero_sha "${local_sha}"; then
    continue
  fi

  if is_zero_sha "${remote_sha}"; then
    # New remote ref: consider commits that are not already known by the remote.
    mapfile -t commits < <(git rev-list "${local_sha}" --not --remotes="${remote_name}")
  else
    mapfile -t commits < <(git rev-list "${remote_sha}..${local_sha}")
  fi

  for commit in "${commits[@]:-}"; do
    while read -r file; do
      [[ -z "${file}" ]] && continue
      [[ "${file}" == src/* ]] && src_changed=1
      [[ "${file}" == "VERSION" ]] && version_changed=1
    done < <(git diff-tree --no-commit-id --name-only -r "${commit}")
  done
done

if [[ "${src_changed}" -eq 1 && "${version_changed}" -eq 0 ]]; then
  cat >&2 <<'EOF'
ERROR: Push blocked.
Detected changes under src/** without a VERSION update in pushed commits.

Fix:
  scripts/release/bump-app-version.sh
  git add VERSION k8s/apps/ingester/deployment.yaml k8s/apps/processor/deployment.yaml k8s/apps/health/deployment.yaml k8s/apps/admin-scale/deployment.yaml
  git commit --amend --no-edit    # or create a follow-up commit

Temporary bypass (local only):
  SKIP_VERSION_GUARD=1 git push
EOF
  exit 1
fi

exit 0
