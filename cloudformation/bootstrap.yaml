AWSTemplateFormatVersion: "2010-09-09"
Description: "CloudRadar bootstrap: AWS Budget, GitHub OIDC provider, and Terraform CI role."

Parameters:
  RoleName:
    Type: String
    Default: CloudRadarTerraformRole
    Description: IAM role name assumed by GitHub Actions via OIDC.
  RepoSlug:
    Type: String
    Default: ClementV78/CloudRadar
    Description: GitHub repo in owner/name format.
  OidcProviderUrl:
    Type: String
    Default: token.actions.githubusercontent.com
    Description: GitHub OIDC provider URL (without https://).
  OidcThumbprint:
    Type: String
    Default: 6938fd4d98bab03faadb97b34396831e3780aea1
    Description: Root CA thumbprint for GitHub OIDC.
  OidcProviderTag:
    Type: String
    Default: github-actions-oidc
    Description: Tag value for the OIDC provider.
  StateBucketPrefix:
    Type: String
    Default: cloudradar-tfstate-
    Description: Prefix for Terraform state bucket (unique suffix required).
  LockTableName:
    Type: String
    Default: cloudradar-tf-lock
    Description: DynamoDB table name for Terraform locks.
  BudgetAmount:
    Type: Number
    Default: 10
    Description: Monthly budget in USD.
  BudgetName:
    Type: String
    Default: cloudradar-monthly-budget
    Description: Budget name.
  AlertEmail:
    Type: String
    Description: Email for budget alerts.

Resources:
  GitHubOidcProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: !Sub "https://${OidcProviderUrl}"
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - !Ref OidcThumbprint
      Tags:
        - Key: Name
          Value: !Ref OidcProviderTag

  TerraformCiRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref RoleName
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Ref GitHubOidcProvider
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              StringLike:
                token.actions.githubusercontent.com:sub: !Sub "repo:${RepoSlug}:*"
      Policies:
        - PolicyName: CloudRadarTerraformBootstrap
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:CreateBucket
                Resource: "*"
              - Effect: Allow
                Action:
                  - s3:PutBucketEncryption
                  - s3:PutBucketVersioning
                  - s3:PutPublicAccessBlock
                  - s3:PutBucketTagging
                  - s3:ListBucket
                Resource: !Sub "arn:aws:s3:::${StateBucketPrefix}*"
              - Effect: Allow
                Action:
                  - dynamodb:CreateTable
                  - dynamodb:DescribeTable
                  - dynamodb:TagResource
                Resource: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${LockTableName}"

  MonthlyBudget:
    Type: AWS::Budgets::Budget
    Properties:
      Budget:
        BudgetName: !Ref BudgetName
        BudgetLimit:
          Amount: !Ref BudgetAmount
          Unit: USD
        BudgetType: COST
        TimeUnit: MONTHLY
      NotificationsWithSubscribers:
        - Notification:
            NotificationType: ACTUAL
            ComparisonOperator: GREATER_THAN
            Threshold: 100
            ThresholdType: PERCENTAGE
          Subscribers:
            - SubscriptionType: EMAIL
              Address: !Ref AlertEmail

Outputs:
  OidcProviderArn:
    Value: !Ref GitHubOidcProvider
  TerraformCiRoleArn:
    Value: !GetAtt TerraformCiRole.Arn
