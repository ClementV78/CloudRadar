name: Verify Issue Metadata

on:
  issues:
    types: [opened, edited]

jobs:
  check-metadata:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check metadata
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const missing = [];
            
            // Check assignees
            if (!issue.assignees || issue.assignees.length === 0) {
              missing.push("❌ **Assignee**: Not assigned");
            } else {
              missing.push("✅ Assignee: " + issue.assignees.map(a => `@${a.login}`).join(", "));
            }
            
            // Check labels
            if (!issue.labels || issue.labels.length === 0) {
              missing.push("❌ **Labels**: Not set");
            } else {
              missing.push("✅ Labels: " + issue.labels.map(l => `\`${l.name}\``).join(", "));
            }
            
            // Check milestone
            if (!issue.milestone) {
              missing.push("❌ **Milestone**: Not set (required: v1-mvp, v1.1, or v2)");
            } else {
              missing.push("✅ Milestone: `" + issue.milestone.title + "`");
            }
            
            // Check project association
            let hasProject = false;
            try {
              const projects = await github.graphql(`
                query($owner:String!, $repo:String!, $issueNumber:Int!) {
                  repository(owner:$owner, name:$repo) {
                    issue(number:$issueNumber) {
                      projectsV2(first:10) {
                        nodes {
                          title
                        }
                      }
                    }
                  }
                }
              `, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issueNumber: issue.number
              });
              
              const projectNodes = projects.repository.issue.projectsV2.nodes;
              if (projectNodes && projectNodes.length > 0) {
                hasProject = true;
                missing.push("✅ Project: " + projectNodes.map(p => `\`${p.title}\``).join(", "));
              } else {
                missing.push("❌ **Project**: Not added to CloudRadar project");
              }
            } catch (error) {
              console.log("Could not check project association");
              missing.push("⚠️ **Project**: Could not verify (manual check needed)");
            }
            
            // Determine if needs attention
            const needsAttention = !issue.assignees || issue.assignees.length === 0 || 
                                  !issue.labels || issue.labels.length === 0 || 
                                  !issue.milestone || !hasProject;
            
            if (needsAttention) {
              // Check if already labeled
              const hasMetadataLabel = issue.labels && issue.labels.some(l => l.name === "needs-metadata");
              
              if (!hasMetadataLabel) {
                // Add label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ["needs-metadata"]
                });
              }
              
              // Post comment
              const comment = `⚠️ **Metadata Check**\n\n${missing.join("\n")}\n\n**Required metadata:**\n- Assignee (usually yourself)\n- Labels: \`area/*\` + version (\`v1-mvp\`, \`v1.1\`, or \`v2\`)\n- Milestone: \`v1-mvp\`, \`v1.1\`, or \`v2\`\n- Project: Add to **CloudRadar** project board\n\nPlease update to complete this issue.`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: comment
              });
            } else {
              console.log("✅ All metadata present");
              console.log(missing.join("\n"));
              
              // Remove needs-metadata label if present
              if (issue.labels && issue.labels.some(l => l.name === "needs-metadata")) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  name: "needs-metadata"
                });
              }
            }
